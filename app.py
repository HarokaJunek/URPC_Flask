from flask import Flask, render_template, request, redirect, url_for, session, flash
import os
import sqlite3
from datetime import datetime
from werkzeug.security import generate_password_hash, check_password_hash

# ============================================================================
# 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# ============================================================================

app = Flask(__name__)

# –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ —Å–µ—Å—Å–∏–π
# –í–ù–ò–ú–ê–ù–ò–ï: –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª—É—á–∞–π–Ω—ã–π —Å–ª–æ–∂–Ω—ã–π –∫–ª—é—á!
app.secret_key = 'your-secret-key-123-change-this'

# –ë–∞–∑–∞ –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å—Å—è –≤ –ø–∞–ø–∫–µ instance —Ä—è–¥–æ–º —Å main.py
DATABASE = os.path.join('instance', 'nagruzka_DEMO.db')

# ============================================================================
# 2. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ë–î
# ============================================================================

def get_db_connection():
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        connection object —Å row_factory = sqlite3.Row
        –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –∫–æ–ª–æ–Ω–∫–∞–º –ø–æ –∏–º–µ–Ω–∏: row['username']

    –í–∞–∂–Ω–æ: –ú—ã –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –ë–î –∏ —Ç–∞–±–ª–∏—Ü—ã —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –≤—Ä—É—á–Ω—É—é!
    """
    conn = sqlite3.connect(DATABASE)

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º row_factory –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
    conn.row_factory = sqlite3.Row

    return conn







# ============================================================================
# 5. –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
# ============================================================================

@app.route('/register', methods=['GET', 'POST'])
def register():
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    GET: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    POST: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î

    –ü—Ä–æ—Ü–µ—Å—Å:
    1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–æ—Ä–º—ã
    2. –í–∞–ª–∏–¥–∞—Ü–∏—è (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏)
    3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –≤ –ë–î
    4. –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è
    5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü—ã users –∏ profiles
    6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
    """

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    if 'user_id' in session:
        flash('–í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã! –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤—ã–π–¥–∏—Ç–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.', 'info')
        return redirect(url_for('index'))

    # ============================================
    # –û–ë–†–ê–ë–û–¢–ö–ê POST-–ó–ê–ü–†–û–°–ê (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã)
    # ============================================
    if request.method == 'POST':

        # 1. –ü–û–õ–£–ß–ê–ï–ú –î–ê–ù–ù–´–ï –ò–ó –§–û–†–ú–´
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º .get() –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        username = request.form.get('username', '').strip()
        email = request.form.get('email', '').strip().lower()
        password = request.form.get('password', '')
        confirm_password = request.form.get('confirmPassword', '')
        full_name = request.form.get('fullName', '')
        phone = request.form.get('phone', '')

        # ============================================
        # 2. –í–ê–õ–ò–î–ê–¶–ò–Ø –î–ê–ù–ù–´–• (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏)
        # ============================================
        errors = []

        # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
        if not username:
            errors.append('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è')
        elif len(username) < 3:
            errors.append('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤')
        elif len(username) > 20:
            errors.append('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –±–æ–ª–µ–µ 20 —Å–∏–º–≤–æ–ª–æ–≤')
        elif not username.replace('_', '').isalnum():
            errors.append('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ')

        # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ email ---
        if not email:
            errors.append('Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è')
        elif '@' not in email or '.' not in email:
            errors.append('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å')
        elif len(email) > 100:
            errors.append('Email —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π')

        # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è ---
        if not password:
            errors.append('–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è')
        elif len(password) < 6:
            errors.append('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤')
        elif password != confirm_password:
            errors.append('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç')

        # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –§–ò–û ---
        if not full_name:
            errors.append('–§–ò–û –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è')

        # –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
        if errors:
            for error in errors:
                flash(error, 'danger')
            return render_template('register.html')

        # ============================================
        # 3. –ü–†–û–í–ï–†–ö–ê –£–ù–ò–ö–ê–õ–¨–ù–û–°–¢–ò –í –ë–ê–ó–ï –î–ê–ù–ù–´–•
        # ============================================

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
        conn = get_db_connection()

        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username
            existing_user = conn.execute(
                'SELECT id_user FROM users WHERE login = ?',
                (username,)
            ).fetchone()

            if existing_user:
                flash('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', 'danger')
                conn.close()
                return render_template('register.html')

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email
            existing_email = conn.execute(
                'SELECT id_user FROM users WHERE email = ?',
                (email,)
            ).fetchone()

            if existing_email:
                flash('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', 'danger')
                conn.close()
                return render_template('register.html')


            # ============================================
            # 4. –•–ï–®–ò–†–û–í–ê–ù–ò–ï –ü–ê–†–û–õ–Ø
            # ============================================

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ö–µ—à –ø–∞—Ä–æ–ª—è
            # werkzeug.security –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç "—Å–æ–ª—å" (salt) –¥–ª—è –∑–∞—â–∏—Ç—ã
            password_hash = generate_password_hash(password)

            # ============================================
            # 5. –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ë–ê–ó–£ –î–ê–ù–ù–´–•
            # ============================================

            # –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
            conn.execute('BEGIN TRANSACTION')

            try:
                # 5.1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É users
                cursor = conn.cursor()
                cursor.execute('''
                               INSERT INTO users (login, email, password, phone, full_name, created_at)
                               VALUES (?, ?, ?, ?, ?, datetime('now', 'localtime'))
                               ''', (username, email, password_hash, phone, full_name))
                # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                conn.commit()

                # ============================================
                # 6. –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û–ë –£–°–ü–ï–•–ï
                # ============================================
                flash(f'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {full_name}!', 'success')
                flash('–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.', 'info')

                # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                return redirect(url_for('index'))

            except sqlite3.Error as e:
                # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
                conn.rollback()
                flash(f'–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {str(e)}', 'danger')
                return render_template('register.html')

        except sqlite3.Error as e:
            flash('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'danger')
            flash(f'–û—à–∏–±–∫–∞ –ë–î: {str(e)}', 'danger')
            return render_template('register.html')

        finally:
            # –í—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
            conn.close()

    # ============================================
    # –û–ë–†–ê–ë–û–¢–ö–ê GET-–ó–ê–ü–†–û–°–ê (–ø–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã)
    # ============================================
    return render_template('register.html')








@app.route('/',methods=['GET', 'POST'])
def index():
    # ============================================
    # –û–ë–†–ê–ë–û–¢–ö–ê POST-–ó–ê–ü–†–û–°–ê (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã)
    # ============================================
    if request.method == 'POST':
        # 1. –ü–û–õ–£–ß–ê–ï–ú –î–ê–ù–ù–´–ï –ò–ó –§–û–†–ú–´
        login_input = request.form.get('username', '').strip()
        password = request.form.get('password', '')

        print(f"üì• –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:")
        print(f"   –õ–æ–≥–∏–Ω: {login_input}")
        print(f"   –ü–∞—Ä–æ–ª—å: {'*' * len(password)}")

        # ============================================
        # 2. –í–ê–õ–ò–î–ê–¶–ò–Ø –í–•–û–î–ù–´–• –î–ê–ù–ù–´–•
        # ============================================
        errors = []

        if not login_input:
            errors.append('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ email')
        if not password:
            errors.append('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å')

        # ============================================
        # 3. –ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í –ë–ê–ó–ï –î–ê–ù–ù–´–•
        # ============================================

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
        conn = get_db_connection()

        try:
            # –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username –ò–õ–ò email
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–≤–µ—Å—Ç–∏ –ª—é–±–æ–µ –∏–∑ –¥–≤—É—Ö
            user = conn.execute('''
                                    SELECT id_user, full_name, email, login, password, id_role, kol_auth
                                    FROM users
                                    WHERE login = ?
                                       OR email = ?
                                    ''', (login_input, login_input,)).fetchone()

            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
            if not user:
                # –ù–µ –≥–æ–≤–æ—Ä–∏–º —Ç–æ—á–Ω–æ, —á—Ç–æ –Ω–µ —Ç–∞–∫ (–ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å)
                # –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                flash('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/email –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'danger')
                conn.close()
                return render_template('index.html')


            # ============================================
            # 4. –ü–†–û–í–ï–†–ö–ê –ü–ê–†–û–õ–Ø
            # ============================================

            # check_password_hash —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å —Å —Ö–µ—à–µ–º –∏–∑ –ë–î
            # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –µ—Å–ª–∏ –ø–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π, False –µ—Å–ª–∏ –Ω–µ—Ç
            if not check_password_hash(user['password'], password):
                # –¢–∞ –∂–µ —Å–∞–º–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                flash('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/email –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'danger')
                conn.close()
                return render_template('index.html')

            # ============================================
            # 5. –°–û–ó–î–ê–ù–ò–ï –°–ï–°–°–ò–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
            # ============================================

            # Flask —Å–µ—Å—Å–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫—É–∫–∞—Ö –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
            # –í–∞–∂–Ω–æ: –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Å—Å–∏–∏!

            session['user_id'] = user['id_user']
            session['username'] = user['login']
            session['email'] = user['email']
            session['full_name'] = user['full_name']
            match int(user['id_role']):
                case 1:
                    session['is_guest'] = True
                case 2:
                    session['is_admin'] = True
                case 3:
                    session['is_zav'] = True
                case 4:
                    session['is_prepod'] = True
                case 5:
                    session['is_specialist'] = True
                case _:
                    session['is_guest'] = False
                    session['is_admin'] = False
                    session['is_zav'] = False
                    session['is_prepod'] = False
                    session['is_specialist'] = False

            session['login_time'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')


            try:
                # 5.1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É users
                cursor = conn.cursor()
                cursor.execute('''
                               UPDATE users SET
                               kol_auth = ?, last_auth = ?
                                WHERE id_user = ?
                               ''', (int(user['kol_auth']) + 1, session['login_time'], session['user_id']))
                # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                conn.commit()
            except sqlite3.Error as e:
                # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
                conn.rollback()
                flash(f'–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {str(e)}', 'danger')

            print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω:")
            print(f"   ID: {user['id_user']}")
            print(f"   Username: {user['login']}")

            # ============================================
            # 6. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û–°–õ–ï–î–ù–ï–ô –ê–ö–¢–ò–í–ù–û–°–¢–ò (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            # ============================================
            # –í —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö —á–∞—Å—Ç–æ –¥–æ–±–∞–≤–ª—è—é—Ç –ø–æ–ª–µ last_login
            # conn.execute('UPDATE users SET last_login = datetime("now") WHERE id = ?', (user['id'],))
            # conn.commit()

            # ============================================
            # 7. –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ò –ü–ï–†–ï–ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï
            # ============================================

            flash(f'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {session['full_name']}!', 'success')

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä 'next' (–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞)
            next_page = request.args.get('next')

            if next_page:
                return redirect(next_page)


            # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
            #if user['is_admin']:
                print("üöÄ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å")
                return redirect(url_for('admin_dashboard'))
            #else:
            print("üè† –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é")
            return redirect(url_for('index'))

        except sqlite3.Error as e:
            flash('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'danger')
            return render_template('index.html')

        finally:
            # –í—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
            conn.close()

    # ============================================
    # –û–ë–†–ê–ë–û–¢–ö–ê GET-–ó–ê–ü–†–û–°–ê (–ø–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã)
    # ============================================
    return render_template('index.html')

@app.route('/logout')
def logout():
    """
    –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã - –æ—á–∏—Å—Ç–∫–∞ —Å–µ—Å—Å–∏–∏.

    –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã—Ö–æ–¥ –≤–∫–ª—é—á–∞–µ—Ç:
    1. –û—á–∏—Å—Ç–∫—É –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–∏
    2. –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    3. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    """

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    if 'user_id' in session:
        username = session.get('username', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π')

        # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π)
        username = session.get('username', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')

        full_name = session['full_name']

        # –ü–û–õ–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ —Å–µ—Å—Å–∏–∏
        session.clear()

        flash(f'–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è, {full_name}!', 'info')
    else:
        flash('–í—ã –Ω–µ –±—ã–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.', 'warning')

    return redirect(url_for('index'))









@app.route('/edit_users')
def edit_users():
    return render_template('edit_users.html')





if __name__ == '__main__':
    if not os.path.exists(DATABASE):
        print("‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
    else:
        app.run(debug=True, host='0.0.0.0', port=5001)