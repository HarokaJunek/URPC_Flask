from flask import Flask, render_template, request, redirect, url_for, session, flash
import os
import sqlite3
from datetime import datetime
from werkzeug.security import generate_password_hash, check_password_hash

# ============================================================================
# 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# ============================================================================

app = Flask(__name__)

# –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ —Å–µ—Å—Å–∏–π
# –í–ù–ò–ú–ê–ù–ò–ï: –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª—É—á–∞–π–Ω—ã–π —Å–ª–æ–∂–Ω—ã–π –∫–ª—é—á!
app.secret_key = 'your-secret-key-123-change-this'

# –ë–∞–∑–∞ –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å—Å—è –≤ –ø–∞–ø–∫–µ instance —Ä—è–¥–æ–º —Å main.py
DATABASE = os.path.join('instance', 'nagruzka_DEMO.db')

# ============================================================================
# 2. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ë–î
# ============================================================================

def get_db_connection():
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        connection object —Å row_factory = sqlite3.Row
        –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –∫–æ–ª–æ–Ω–∫–∞–º –ø–æ –∏–º–µ–Ω–∏: row['username']

    –í–∞–∂–Ω–æ: –ú—ã –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –ë–î –∏ —Ç–∞–±–ª–∏—Ü—ã —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –≤—Ä—É—á–Ω—É—é!
    """
    conn = sqlite3.connect(DATABASE)

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º row_factory –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
    conn.row_factory = sqlite3.Row

    return conn


@app.route('/',methods=['GET', 'POST'])
def index():
    # ============================================
    # –û–ë–†–ê–ë–û–¢–ö–ê POST-–ó–ê–ü–†–û–°–ê (–æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã)
    # ============================================
    if request.method == 'POST':
        # 1. –ü–û–õ–£–ß–ê–ï–ú –î–ê–ù–ù–´–ï –ò–ó –§–û–†–ú–´
        login_input = request.form.get('username', '').strip()
        password = request.form.get('password', '')

        print(f"üì• –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:")
        print(f"   –õ–æ–≥–∏–Ω: {login_input}")
        print(f"   –ü–∞—Ä–æ–ª—å: {'*' * len(password)}")

        # ============================================
        # 2. –í–ê–õ–ò–î–ê–¶–ò–Ø –í–•–û–î–ù–´–• –î–ê–ù–ù–´–•
        # ============================================
        errors = []

        if not login_input:
            errors.append('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ email')
        if not password:
            errors.append('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å')

            # ============================================
            # 3. –ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í –ë–ê–ó–ï –î–ê–ù–ù–´–•
            # ============================================

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
            conn = get_db_connection()

            try:
                # –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username –ò–õ–ò email
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–≤–µ—Å—Ç–∏ –ª—é–±–æ–µ –∏–∑ –¥–≤—É—Ö
                user = conn.execute('''
                                    SELECT id_user, email, login, password, id_role
                                    FROM users
                                    WHERE (login = ?
                                       OR email = ?) and password = ?
                                    ''', (login_input, login_input, password)).fetchone()

                # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
                if not user:
                    # –ù–µ –≥–æ–≤–æ—Ä–∏–º —Ç–æ—á–Ω–æ, —á—Ç–æ –Ω–µ —Ç–∞–∫ (–ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å)
                    # –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                    flash('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/email –∏–ª–∏ –ø–∞—Ä–æ–ª—å1', 'danger')
                    conn.close()
                    return render_template('index.html')

                # ============================================
                # 4. –ü–†–û–í–ï–†–ö–ê –ü–ê–†–û–õ–Ø
                # ============================================

                # check_password_hash —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å —Å —Ö–µ—à–µ–º –∏–∑ –ë–î
                # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –µ—Å–ª–∏ –ø–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π, False –µ—Å–ª–∏ –Ω–µ—Ç
                if not check_password_hash(user['password'], password):
                    # –¢–∞ –∂–µ —Å–∞–º–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                    flash('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/email –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'danger')
                    conn.close()
                    return render_template('index.html')

                # ============================================
                # 5. –°–û–ó–î–ê–ù–ò–ï –°–ï–°–°–ò–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
                # ============================================

                # Flask —Å–µ—Å—Å–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫—É–∫–∞—Ö –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
                # –í–∞–∂–Ω–æ: –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Å—Å–∏–∏!

                session['user_id'] = user['id_user']
                session['username'] = user['login']
                session['email'] = user['email']
                session['role'] = int(user['id_role'])  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º 0/1 –≤ True/False
                session['login_time'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

                print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω:")
                print(f"   ID: {user['id_user']}")
                print(f"   Username: {user['login']}")

                # ============================================
                # 6. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û–°–õ–ï–î–ù–ï–ô –ê–ö–¢–ò–í–ù–û–°–¢–ò (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                # ============================================
                # –í —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö —á–∞—Å—Ç–æ –¥–æ–±–∞–≤–ª—è—é—Ç –ø–æ–ª–µ last_login
                # conn.execute('UPDATE users SET last_login = datetime("now") WHERE id = ?', (user['id'],))
                # conn.commit()

                # ============================================
                # 7. –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ò –ü–ï–†–ï–ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï
                # ============================================

                flash(f'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user["username"]}!', 'success')

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä 'next' (–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞)
                next_page = request.args.get('next')

                if next_page:
                    return redirect(next_page)

                # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
                #if user['is_admin']:
                    print("üöÄ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å")
                    return redirect(url_for('admin_dashboard'))
                #else:
                print("üè† –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é")
                return redirect(url_for('index'))

            except sqlite3.Error as e:
                flash('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'danger')
                return render_template('index.html')

            finally:
                # –í—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
                conn.close()

        # ============================================
        # –û–ë–†–ê–ë–û–¢–ö–ê GET-–ó–ê–ü–†–û–°–ê (–ø–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã)
        # ============================================
        return render_template('index.html')
    return render_template('index.html')




if __name__ == '__main__':
    if not os.path.exists(DATABASE):
        print("‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
    else:
        app.run(debug=True, host='0.0.0.0', port=5001)